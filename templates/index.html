<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Combined Login & Discussion Rooms</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
    </style>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    {% if is_authenticated %}
    <!-- =======================
         Authenticated (Chat Home)
         ======================= -->
    <header
      class="sticky top-0 z-50 backdrop-blur-sm bg-white/80 border-b border-gray-200"
    >
      <div class="max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div
          class="flex flex-col sm:flex-row items-center justify-between gap-4"
        >
          <div class="flex items-center space-x-3">
            <h1
              class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-indigo-600 to-blue-500 bg-clip-text text-transparent"
            >
              Discussion Forum
            </h1>
          </div>
          <div class="flex items-center space-x-4">
            <p class="text-sm text-gray-600">
              Welcome,
              <span class="font-semibold text-gray-900">{{ username }}</span>
            </p>
            <!-- Logout link -->
            <a
              href="{{ url_for('logout') }}"
              class="inline-flex items-center px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 font-medium text-sm"
            >
              Logout
            </a>
          </div>
        </div>
      </div>
    </header>

    <main class="py-8 px-4 sm:px-6 lg:px-8">
      <div class="max-w-7xl mx-auto">
        <!-- Optional error message (e.g. role check fail or invalid pass) -->
        {% if error %}
          <div class="mb-4 text-sm text-red-600 text-center">{{ error }}</div>
        {% endif %}

        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
          <h2 class="text-2xl sm:text-3xl font-bold text-gray-900">
            Discussion Rooms
          </h2>
          <button
            onclick="document.getElementById('createRoomForm').classList.toggle('hidden')"
            class="mt-4 sm:mt-0 inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors duration-200 font-medium text-sm"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-2"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                clip-rule="evenodd"
              />
            </svg>
            Create New Room
          </button>
        </div>

        <!-- Create Room Form -->
        <div
          id="createRoomForm"
          class="hidden mb-8 bg-white rounded-xl shadow-sm border border-gray-200 p-6"
        >
          <form
            action="{{ url_for('create_room') }}"
            method="POST"
            class="max-w-md mx-auto"
          >
            <div class="mb-4">
              <label
                for="room_name"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Room Name</label
              >
              <input
                type="text"
                name="room_name"
                id="room_name"
                required
                class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200"
                placeholder="Enter room name..."
              />
            </div>
            <button
              type="submit"
              class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-200 font-medium"
            >
              Create Room
            </button>
          </form>
        </div>

        <!-- Rooms Grid -->
        <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for room in rooms %}
          <li
            class="group bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow duration-200 border border-gray-200"
          >
            <div class="p-6">
              <div class="flex justify-between items-start mb-4">
                <a
                  href="{{ url_for('chat', room_id=room.id) }}"
                  class="text-lg font-semibold text-gray-900 hover:text-indigo-600 transition-colors duration-200"
                >
                  {{ room.name }}
                </a>
                <div id="unread-{{ room.id }}" class="flex items-center">
                  {% if room.unread > 0 %}
                  <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"
                  >
                    {{ room.unread }} new
                  </span>
                  {% else %}
                  <span class="text-sm text-gray-500">No new messages</span>
                  {% endif %}
                </div>
              </div>
              <div class="flex justify-between items-center">
                <div
                  class="group-hover:translate-x-2 transition-transform duration-200"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 text-indigo-600"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                </div>
              </div>
            </div>
          </li>
          {% endfor %}
        </ul>
      </div>
    </main>


    <!-- Authenticated Socket.IO Script -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
      const socket = io();
      const username = "{{ username }}";

      socket.on("connect", () => {
        socket.emit("register_index", { username, sid: socket.id });
      });

      socket.on("unread_update", (data) => {
        const unreadElem = document.getElementById("unread-" + data.room_id);
        if (unreadElem) {
          if (data.unread > 0) {
            unreadElem.innerHTML = `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">${data.unread} new</span>`;
          } else {
            unreadElem.innerHTML = `<span class="text-sm text-gray-500">No new messages</span>`;
          }
        }
      });
    </script>
    {% else %}
    <!-- =======================
         Unauthenticated (Login)
         ======================= -->
    <div class="min-h-screen flex items-center justify-center">
      <div class="w-full max-w-md bg-white rounded-xl shadow-md p-8">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login to Chat</h2>
        {% if error %}
          <div class="mb-4 text-sm text-red-600 text-center">{{ error }}</div>
        {% endif %}
        <form method="POST" action="/" class="space-y-4">
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" name="email" id="email" required
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="you@example.com" />
          </div>
          <div>
            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" name="password" id="password" required
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Your password" />
          </div>
          <button type="submit" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors font-medium">
            Login
          </button>
        </form>
      </div>
    </div>
    {% endif %}
  </body>
</html>
